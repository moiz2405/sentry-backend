version: '3.8'

services:
  sentry-backend:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: sentry-backend
    restart: unless-stopped
    ports:
      - "8002:8002"
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - CLICKHOUSE_PASSWORD=clickhouse_password
    volumes:
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - clickhouse
      - jaeger
      - otel-collector

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: sentry-clickhouse
    restart: unless-stopped
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=clickhouse_password
      - CLICKHOUSE_DB=otel
    volumes:
      - clickhouse-data:/var/lib/clickhouse

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: sentry-jaeger
    restart: unless-stopped
    ports:
      - "16686:16686" # Web UI
      - "4317:4317"   # OTLP gRPC

  prometheus:
    image: prom/prometheus:latest
    container_name: sentry-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: sentry-otel-collector
    restart: unless-stopped
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    ports:
      - "4318:4318"   # OTLP HTTP
      - "8889:8889"   # Prometheus metrics
    volumes:
      - ./docker/otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml
    depends_on:
      - clickhouse
      - jaeger
      - prometheus

volumes:
  clickhouse-data:

networks:
  default:
    name: sentry-network
