version: '3.8'

services:
  sentry-backend:
    build: .
    container_name: sentry-backend
    ports:
      - "8002:8002"
    restart: always
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - CLICKHOUSE_PASSWORD=clickhouse_password
    volumes:
      - .:/app
    depends_on:
      - clickhouse
      - jaeger
      - otel-collector

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: sentry-clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=clickhouse_password
      - CLICKHOUSE_DB=otel
    volumes:
      - clickhouse-data:/var/lib/clickhouse

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: sentry-jaeger
    ports:
      - "16686:16686" # Web UI
      - "4317:4317"   # OTLP gRPC

  prometheus:
    image: prom/prometheus:latest
    container_name: sentry-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: sentry-otel-collector
    restart: always
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    ports:
      - "4318:4318"   # OTLP HTTP
      - "8889:8889"   # Prometheus metrics
    volumes:
      - ./docker/otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml
    depends_on:
      - clickhouse
      - jaeger
      - prometheus

volumes:
  clickhouse-data:

networks:
  default:
    name: sentry-network
